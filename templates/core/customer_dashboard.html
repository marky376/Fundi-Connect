{% extends 'base/base.html' %}
{% block title %}Customer Dashboard{% endblock %}
{% block content %}
<section class="container py-5">
  <!-- Popular Services Section -->
  <section class="mb-5">
    <div class="container">
      <div class="text-center mb-4">
        <h3 class="fw-bold mb-2 text-primary"><i class="bi bi-stars me-2"></i>Popular Services</h3>
        <p class="text-muted">Quickly find professionals for these common services</p>
      </div>
      <div class="row g-4 justify-content-center">
        {% if categories %}
          {% for category in categories %}
          <div class="col-md-3 col-6">
            <div class="card h-100 text-center border-0 shadow-sm customer-card-hover">
              <div class="card-body">
                <div class="mb-3">
                  {% if category.name == 'Plumbing' %}
                    <i class="bi bi-wrench display-6 text-primary"></i>
                  {% elif category.name == 'Electrical' %}
                    <i class="bi bi-lightning display-6 text-warning"></i>
                  {% elif category.name == 'Carpentry' %}
                    <i class="bi bi-hammer display-6 text-success"></i>
                  {% elif category.name == 'Cleaning' %}
                    <i class="bi bi-house display-6 text-info"></i>
                  {% else %}
                    <i class="bi bi-tools display-6 text-primary"></i>
                  {% endif %}
                </div>
                <h6 class="card-title">{{ category.name }}</h6>
                <p class="card-text text-muted small">{{ category.description|truncatewords:8 }}</p>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="col-md-3 col-6">
            <div class="card h-100 text-center border-0 shadow-sm customer-card-hover">
              <div class="card-body">
                <i class="bi bi-wrench display-6 text-primary mb-3"></i>
                <h6 class="card-title">Plumbing</h6>
                <p class="card-text text-muted small">Repairs, installations, maintenance</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card h-100 text-center border-0 shadow-sm customer-card-hover">
              <div class="card-body">
                <i class="bi bi-lightning display-6 text-warning mb-3"></i>
                <h6 class="card-title">Electrical</h6>
                <p class="card-text text-muted small">Wiring, outlets, lighting</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card h-100 text-center border-0 shadow-sm customer-card-hover">
              <div class="card-body">
                <i class="bi bi-hammer display-6 text-success mb-3"></i>
                <h6 class="card-title">Carpentry</h6>
                <p class="card-text text-muted small">Furniture, repairs, custom work</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card h-100 text-center border-0 shadow-sm customer-card-hover">
              <div class="card-body">
                <i class="bi bi-house display-6 text-info mb-3"></i>
                <h6 class="card-title">Cleaning</h6>
                <p class="card-text text-muted small">Deep cleaning, maintenance</p>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
  <div class="row">
    <div class="col-md-8">
      <div class="mb-4">
        <h2 class="fw-bold text-primary mb-2">
          <i class="bi bi-person-circle me-2"></i>Welcome, <span class="text-gradient">{{ user.first_name|default:user.email }}</span>!
        </h2>
        <p class="text-muted">Your personalized dashboard for managing jobs and finding Fundis nearby.</p>
      </div>
      <div class="card mb-4 shadow-lg border-0 customer-card-hover" style="background: linear-gradient(135deg, #e0e7ff 0%, #f0fdf4 100%);">
        <div class="card-body">
          <h4 class="mb-3 text-primary"><i class="bi bi-briefcase me-2"></i>Your Recent Jobs</h4>
          {% if user_jobs %}
            <ul class="list-group list-group-flush">
              {% for job in user_jobs %}
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <div>
                    <span class="fw-semibold text-dark"><i class="bi bi-hammer me-2 text-accent"></i>{{ job.title }}</span>
                    <span class="badge bg-secondary ms-2">{{ job.status|title }}</span>
                  </div>
                  <a href="{% url 'jobs:job_detail_jobs' job.id %}" class="btn btn-outline-primary btn-sm ms-3">View</a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center py-4">
              <i class="bi bi-emoji-frown display-4 text-muted mb-2"></i>
              <p class="text-muted">You haven't posted any jobs yet.</p>
              <a href="{% url 'jobs:job_create' %}" class="btn btn-primary mt-2"><i class="bi bi-plus-circle me-1"></i>Post a Job</a>
            </div>
          {% endif %}
        </div>
      </div>
      <div class="card mb-4 shadow-lg border-0 customer-card-hover" style="background: linear-gradient(135deg, #f0fdf4 0%, #e0e7ff 100%);">
        <div class="card-body">
          <h4 class="mb-3 text-success"><i class="bi bi-geo-alt me-2"></i>Nearby Fundis</h4>
          <form id="fundi-filter-form" class="mb-3 d-flex flex-wrap gap-2">
            <div class="input-group flex-grow-1">
              <span class="input-group-text bg-white"><i class="bi bi-search text-primary"></i></span>
              <input type="text" id="skill-filter" class="form-control" placeholder="Filter by skill (e.g. Plumbing)">
            </div>
            <select id="status-filter" class="form-select w-auto">
              <option value="">All Status</option>
              <option value="true">Available</option>
              <option value="false">Unavailable</option>
            </select>
            <button type="button" class="btn btn-outline-primary" onclick="updateFundis()"><i class="bi bi-funnel me-1"></i>Apply Filter</button>
          </form>
          <div id="fundi-map" style="height: 350px; border-radius: 12px; overflow: hidden;"></div>
          <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
          <link rel="stylesheet" href="/static/leaflet.markercluster.css" />
          <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              var map = L.map('fundi-map').setView([-1.286389, 36.817223], 12); // Default to Nairobi
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Â© OpenStreetMap contributors'
              }).addTo(map);
              var markerCluster = L.markerClusterGroup();
              map.addLayer(markerCluster);
              var fundiIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149060.png', // Blue marker for fundi
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              });
              var customerIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png', // Avatar icon for customer
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              });
              function getFilterParams() {
                var skill = document.getElementById('skill-filter').value.trim();
                var status = document.getElementById('status-filter').value;
                var params = [];
                if (skill) params.push('skill=' + encodeURIComponent(skill));
                if (status) params.push('available=' + status);
                return params.length ? '?' + params.join('&') : '';
              }
              function updateFundis() {
                var url = '/api/fundi-locations/' + getFilterParams();
                fetch(url)
                  .then(response => response.json())
                  .then(data => {
                    markerCluster.clearLayers();
                    data.fundis.forEach(fundi => {
                      var icon = fundi.available ? fundiIcon : L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1828/1828665.png', // Red marker for unavailable
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                      });
                      var marker = L.marker([fundi.latitude, fundi.longitude], {icon: icon});
                      marker.bindPopup(`<strong>${fundi.name}</strong><br>${fundi.skills.join(', ')}<br>${fundi.location}<br>Status: <span style='color:${fundi.available ? 'green' : 'red'}'>${fundi.available ? 'Available' : 'Unavailable'}</span>`);
                      markerCluster.addLayer(marker);
                    });
                  });
              }
              // Show customer's location as a distinct marker if available
              {% if user.latitude and user.longitude %}
                var customerMarker = L.marker([
                  {{ user.latitude }},
                  {{ user.longitude }}
                ], {icon: customerIcon});
                customerMarker.bindPopup('<strong>Your Location</strong>');
                customerMarker.addTo(map);
                map.setView([{{ user.latitude }}, {{ user.longitude }}], 13);
              {% else %}
                // Center map on browser geolocation if available
                if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(function(position) {
                    map.setView([position.coords.latitude, position.coords.longitude], 13);
                  });
                }
              {% endif %}
              updateFundis();
              setInterval(updateFundis, 10000);
            });
          </script>
          <p class="mt-3 text-muted">Fundis near your location will appear on the map. Click a marker for fundi details.</p>
        </div>
      </div>
    </div>
    <!-- Profile info removed from dashboard. All profile matters are now in the profile page. -->
  </div>
</section>
{% endblock %}
