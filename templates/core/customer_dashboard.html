{% extends 'base/base.html' %}
{% block title %}Customer Dashboard{% endblock %}
{% block content %}
<section class="container py-5">
  <div class="row">
    <div class="col-md-8">
      <h2 class="fw-bold text-primary mb-4">Welcome, {{ user.first_name|default:user.email }}!</h2>
      <div class="card mb-4">
        <div class="card-body">
          <h4 class="mb-3">Your Recent Jobs</h4>
          {% if user_jobs %}
            <ul class="list-group">
              {% for job in user_jobs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ job.title }}</span>
                  <span class="badge bg-secondary">{{ job.status|title }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">You haven't posted any jobs yet.</p>
          {% endif %}
        </div>
      </div>
      <div class="card mb-4">
        <div class="card-body">
          <h4 class="mb-3">Nearby Fundis</h4>
          <form id="fundi-filter-form" class="mb-3 d-flex flex-wrap gap-2">
            <input type="text" id="skill-filter" class="form-control" placeholder="Filter by skill (e.g. Plumbing)">
            <select id="status-filter" class="form-select">
              <option value="">All Status</option>
              <option value="true">Available</option>
              <option value="false">Unavailable</option>
            </select>
            <button type="button" class="btn btn-outline-primary" onclick="updateFundis()">Apply Filter</button>
          </form>
          <div id="fundi-map" style="height: 350px;"></div>
          <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
          <link rel="stylesheet" href="/static/leaflet.markercluster.css" />
          <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              var map = L.map('fundi-map').setView([-1.286389, 36.817223], 12); // Default to Nairobi
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Â© OpenStreetMap contributors'
              }).addTo(map);
              var markerCluster = L.markerClusterGroup();
              map.addLayer(markerCluster);
              var fundiIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png', // Example avatar icon
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              });
              function getFilterParams() {
                var skill = document.getElementById('skill-filter').value.trim();
                var status = document.getElementById('status-filter').value;
                var params = [];
                if (skill) params.push('skill=' + encodeURIComponent(skill));
                if (status) params.push('available=' + status);
                return params.length ? '?' + params.join('&') : '';
              }
              function updateFundis() {
                var url = '/api/fundi-locations/' + getFilterParams();
                fetch(url)
                  .then(response => response.json())
                  .then(data => {
                    markerCluster.clearLayers();
                    data.fundis.forEach(fundi => {
                      var icon = fundi.available ? fundiIcon : L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1828/1828665.png', // Red marker for unavailable
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                      });
                      var marker = L.marker([fundi.latitude, fundi.longitude], {icon: icon});
                      marker.bindPopup(`<strong>${fundi.name}</strong><br>${fundi.skills.join(', ')}<br>${fundi.location}<br>Status: <span style='color:${fundi.available ? 'green' : 'red'}'>${fundi.available ? 'Available' : 'Unavailable'}</span>`);
                      markerCluster.addLayer(marker);
                    });
                  });
              }
              // Center map on customer location if available
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                  map.setView([position.coords.latitude, position.coords.longitude], 13);
                });
              }
              updateFundis();
              setInterval(updateFundis, 10000);
            });
          </script>
          <p class="mt-3 text-muted">Fundis near your location will appear on the map. Click a marker for fundi details.</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-body">
          <h4 class="mb-3 text-primary">Account Info</h4>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Role:</strong> Customer</p>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
